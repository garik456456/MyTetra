<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Helvetica,Arial,sans-serif'; font-size:8.25pt; font-weight:600; color:#333333; background-color:#ffffff;">Заметки об оптимизации: О пользе Loop-invariant Code Motion</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555; background-color:transparent;">Это первая заметка из серии статей, посвященных введению в </span><span style=" font-family:'Georgia,serif'; font-size:8.25pt; font-style:italic; color:#555555; background-color:transparent;">теорию оптимизации программ</span><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555;">.</span></p>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555; background-color:transparent;">Приведенные ниже примеры кода написаны на гипотетическом языке программирования, который больше всего похож на C# и Java. Это сделано лишь для того, чтобы сделать публикуемый материал доступным для понимания широкому кругу читателей, без привязки к какому-то одному конкретному языку (и  автоматически к фобиям его фанатов/антифанатов).</span></p>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555; background-color:transparent;">В первой части, мы начнем с рассмотрения так называемого</span><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555;"> </span><a href="http://blogerator.ru/go.php?url=http://en.wikipedia.org/wiki/Loop-invariant_code_motion"><span style=" font-family:'Georgia,serif'; font-size:8.25pt; text-decoration: underline; color:#999999; background-color:transparent;">Loop-invariant Code Motion</span></a><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555;"> (LICM), то есть как понятно из термина — рассмотрим правильность создания циклов.</span></p>
<p align="center" style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><img src="image5079.jpg" /></p>
<p style=" margin-top:20px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Helvetica,Arial,sans-serif'; font-size:8.25pt; color:#555555; background-color:transparent;">Выполнение Loop-invariant Code Motion (LICM) вручную</span></p>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555; background-color:transparent;">Никогда не надейтесь на компилятор в плане LICM — он не такой умный, как вам кажется. Теоретическое доказательство того, что компилятор сумеет провести LICM для заданного цикла, часто бывает на порядок сложнее, чем доказательство возможности применения LICM для данного цикла.</span></p>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555; background-color:transparent;">Рассмотрим классический пример цикла, многочисленные вариации которого присутствуют почти в любом проекте:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">void Foo(</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;">IBar bar</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">)</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-weight:600; color:#800080; background-color:transparent;">for</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">(</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;">int i </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">=</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#0000ff; background-color:transparent;">0</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">;</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;"> i </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">&lt;</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;"> bar</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">.Count();</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;"> i</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">++)</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">Baz(</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;">bar</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">}</span></p>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555; background-color:transparent;">Чтобы компилятор сумел доказать, что в следующем цикле результат вычисления</span><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555;"> </span><span style=" font-family:'Georgia,serif'; font-size:8.25pt; font-weight:600; color:#555555; background-color:transparent;">bar.Count()</span><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555;"> не зависит от текущей итерации и не имеет побочных эффектов, ему нужно:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555; background-color:transparent;" style=" margin-top:20px; margin-bottom:0px; margin-left:11px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Знать все реализации </span><span style=" font-size:18px; font-style:italic;">IBar.Count()</span><span style=" font-size:18px;">. Это невозможно, если данный цикл находится в динамически подключаемой библиотеке с экспортированным интерфейсом </span><span style=" font-size:18px; font-weight:600;">IBar</span><span style=" font-size:18px;">, т.к. все реализации </span><span style=" font-size:18px; font-style:italic;">IBar.Count()</span><span style=" font-size:18px;"> не могут быть известны на момент компиляции цикла по определению.</span></li>
<li style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555; background-color:transparent;" style=" margin-top:0px; margin-bottom:0px; margin-left:11px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Доказать, что </span><span style=" font-size:18px; font-weight:600;">Baz()</span><span style=" font-size:18px;"> не может повлиять на значения, возвращаемые </span><span style=" font-size:18px; font-style:italic;">bar.Count()</span><span style=" font-size:18px;">.</span></li>
<li style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555; background-color:transparent;" style=" margin-top:0px; margin-bottom:20px; margin-left:11px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Доказать, что код, исполняемый в параллельных потоках, не может повлиять на значения, возвращаемое </span><span style=" font-size:18px; font-style:italic;">bar.Count()</span><span style=" font-size:18px;">.</span></li></ul>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555; background-color:transparent;">Поэтому проще и эффективнее самому сделать работу за компилятор и вынести за пределы цикла все вычисления, которые не зависят от конкретной итерации цикла и не имеют побочных эффектов.</span></p>
<p align="center" style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><img src="image31503.jpg" /></p>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555; background-color:transparent;">Для вышеприведенного случая типична следующая очевидная оптимизация:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">void Foo(</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;">IBar bar</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">)</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;">int c </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">=</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;"> bar</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">.Count();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-weight:600; color:#800080; background-color:transparent;">for</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">(</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;">int i </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">=</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#0000ff; background-color:transparent;">0</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">;</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;"> i </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">&lt;</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;"> c</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">;</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;"> i</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">++)</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">Baz(</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;">bar</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">}</span></p>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555; background-color:transparent;">Уже слышу недовольные голоса моих читателей —</span></p>
<p style=" margin-top:20px; margin-bottom:20px; margin-left:10px; margin-right:10px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Georgia,serif'; font-size:8.25pt; font-style:italic; color:#555555; background-color:transparent;">«а что, если</span><span style=" font-family:'Georgia,serif'; font-size:8.25pt; font-style:italic; color:#555555;"> </span><span style=" font-family:'Georgia,serif'; font-size:8.25pt; font-weight:600; font-style:italic; color:#555555; background-color:transparent;">bar.Count()</span><span style=" font-family:'Georgia,serif'; font-size:8.25pt; font-style:italic; color:#555555;"> просто возвращает значение поля bar.count без каких-либо побочных эффектов? В этом случае вышеприведенная оптимизация нисколько не ускорит цикл».</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555; background-color:transparent;" style=" margin-top:20px; margin-bottom:0px; margin-left:11px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Во-первых, на то, чтобы вернуть </span><span style=" font-size:18px; font-style:italic;">bar.count</span><span style=" font-size:18px;">, требуется минимум одна инструкция процессора на каждую итерацию цикла — чтение </span><span style=" font-size:18px; font-style:italic;">bar.count</span><span style=" font-size:18px;"> из памяти. Если каждая итерация цикла выполняется за 200 миллисекунд, а каждое чтение </span><span style=" font-size:18px; font-style:italic;">bar.count</span><span style=" font-size:18px;"> — за 100 наносекунд, то кэширование результата </span><span style=" font-size:18px; font-weight:600;">bar.Count()</span><span style=" font-size:18px;"> перед циклом позволяет ускорить цикл в два раза. Это не такие невероятные цифры, как могут показаться на первый взгляд, если вспомнить, что операция чтения из памяти на современных компьютерах может занимать сотни тактов процессора. Также не забывайте про накладные расходы на вызов </span><span style=" font-size:18px; font-style:italic;">виртуальной функции</span><span style=" font-size:18px;">.</span></li>
<li style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555; background-color:transparent;" style=" margin-top:0px; margin-bottom:20px; margin-left:11px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Во-вторых, откуда вы знаете, что взбредет в голову другим разработчикам, решившим написать собственную реализацию </span><span style=" font-size:18px; font-style:italic;">IBar</span><span style=" font-size:18px;">? Может, они решат вытягивать возвращаемое значение из базы данных или вычислять его с помощью 100500 последовательных запросов к тормозному веб-сервису, находящемуся на другом конце света?</span></li></ul>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555; background-color:transparent;">Второй по распространенности пример неэффективного программирования —</span><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555;"> </span><a href="http://blogerator.ru/go.php?url=http://habrahabr.ru/blogs/java/129494/"><span style=" font-family:'Georgia,serif'; font-size:8.25pt; text-decoration: underline; color:#999999; background-color:transparent;">обращение к синглтонам</span></a><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555;"> внутри наиболее часто вызываемого цикла:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-weight:600; color:#800080; background-color:transparent;">for</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">(;;)</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;">FooSingleton</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">.GetInstance().Bar();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">}}</span></p>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555; background-color:transparent;">или, что почти то же самое:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">void Foo()</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;">FooSingleton</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">.</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;">GetInstance</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">.Baz();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-weight:600; color:#800080; background-color:transparent;">for</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">(;;)</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">Foo();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">}</span></p>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555; background-color:transparent;">Самое интересное начинается, когда</span><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555;"> </span><span style=" font-family:'Georgia,serif'; font-size:8.25pt; font-style:italic; color:#555555; background-color:transparent;">профилирование</span><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555;"> программ с такими циклами показывает, что узким местом является вызов </span><span style=" font-family:'Georgia,serif'; font-size:8.25pt; font-style:italic; color:#555555; background-color:transparent;">FooSingleton.GetInstance()</span><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555;">. Обычно его начинают оптимизировать с помощью печально известного метода </span><a href="http://blogerator.ru/go.php?url=http://en.wikipedia.org/wiki/Double-checked_locking"><span style=" font-family:'Georgia,serif'; font-size:8.25pt; text-decoration: underline; color:#999999; background-color:transparent;">Double-checked locking</span></a><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555;">, хотя на самом деле нужно было всего лишь вручную произвести простейшую LICM-оптимизацию:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">Foo foo =</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;"> FooSingleton</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">.GetInstance();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-weight:600; color:#800080; background-color:transparent;">for</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">(;;)</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;">foo</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">.Bar();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">}</span></p>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555; background-color:transparent;">или, для второго примера:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">void Foo(</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;">Foo foo</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">)</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;">foo</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">.Baz();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;">Foo foo </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">=</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;"> FooSingleton</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">.GetInstance();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-weight:600; color:#800080; background-color:transparent;">for</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">(;;)</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">Foo(</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000;">foo</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#000000; background-color:transparent;">}</span></p>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555; background-color:transparent;">И, вуаля,</span><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555;"> </span><span style=" font-family:'Georgia,serif'; font-size:8.25pt; font-style:italic; color:#555555; background-color:transparent;">FooSingleton.GetInstance()</span><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555;"> больше никогда не появляется в профилировщике.</span></p>
<p style=" margin-top:10px; margin-bottom:0px; margin-left:10px; margin-right:10px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Georgia,serif'; font-size:8.25pt; font-weight:600; color:#ffffff;">Немного об double checked locking</span></p>
<p style=" margin-top:0px; margin-bottom:10px; margin-left:10px; margin-right:10px; -qt-block-indent:0; text-indent:0px; background-color:#feffd5;"><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#333333; background-color:#feffd5;">DCL - это</span><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#333333;"> </span><a href="http://blogerator.ru/go.php?url=http://ru.wikipedia.org/wiki/%C0%ED%F2%E8%EF%E0%F2%F2%E5%F0%ED"><span style=" font-family:'Georgia,serif'; font-size:8.25pt; text-decoration: underline; color:#999999; background-color:transparent;">антипаттерн</span></a><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#333333;">, который норовят использовать все, кто о нем впервые услышал, либо сам до него додумался. Он не работает почти во всех языках программирования, тем самым еще раз подтверждая вред </span><span style=" font-family:'Georgia,serif'; font-size:8.25pt; font-style:italic; color:#333333; background-color:transparent;">преждевременной оптимизации</span><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#333333;">. Если вам нужен быстрый доступ к </span><a href="http://blogerator.ru/go.php?url=http://en.wikipedia.org/wiki/Singleton_pattern"><span style=" font-family:'Georgia,serif'; font-size:8.25pt; text-decoration: underline; color:#999999; background-color:transparent;">синглтону</span></a><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#333333;"> из множества потоков, то кэшируйте указатель на синглтон, возвращаемый синхронизированной </span><a href="http://blogerator.ru/go.php?url=http://en.wikipedia.org/wiki/Factory_method_pattern"><span style=" font-family:'Georgia,serif'; font-size:8.25pt; text-decoration: underline; color:#999999; background-color:transparent;">фабрикой</span></a><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#333333;"> в </span><a href="http://blogerator.ru/go.php?url=http://en.wikipedia.org/wiki/Thread-local_storage"><span style=" font-family:'Georgia,serif'; font-size:8.25pt; text-decoration: underline; color:#999999; background-color:transparent;">thread local storage</span></a><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#333333;">. Смотрите очень наглядный пример &quot;</span><span style=" font-family:'Georgia,serif'; font-size:8.25pt; font-style:italic; color:#333333; background-color:transparent;">Fixing Double-Checked Locking using Thread Local Storage</span><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#333333;">&quot; </span><a href="http://blogerator.ru/go.php?url=http://www.cs.umd.edu/~pugh/java/memoryModel/DoubleCheckedLocking.html"><span style=" font-family:'Georgia,serif'; font-size:8.25pt; text-decoration: underline; color:#999999; background-color:transparent;">здесь</span></a><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#333333;"> (там, правда, кэшируется не совсем указатель). Но делайте это только в том случае, если профилирование показывает, что доступ к </span><span style=" font-family:'Georgia,serif'; font-size:8.25pt; font-style:italic; color:#333333; background-color:transparent;">синглтону</span><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#333333;"> - действительно узкое место, и другие способы оптимизации не помогают.</span></p>
<p style=" margin-top:20px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Helvetica,Arial,sans-serif'; font-size:8.25pt; color:#555555; background-color:transparent;">Заключение</span></p>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555; background-color:transparent;">В следующий раз, когда будете писать либо редактировать циклы, не поленитесь выполнить LICM вручную. Обычно это приводит не только к повышению производительности, но и к улучшению читабельности кода. Продолжение серии этих заметок можно увидеть здесь:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555; background-color:transparent;" style=" margin-top:20px; margin-bottom:0px; margin-left:11px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Заметки об оптимизации: </span><a href="http://blogerator.ru/page/zametki-ob-optimizacii-programm-2-big-o-notation-skorost-algoritmov-i-optimizacija-funkcij"><span style=" font-size:18px; text-decoration: underline; color:#999999;">Big O notation и скорость алгоритмов</span></a></li>
<li style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555; background-color:transparent;" style=" margin-top:0px; margin-bottom:20px; margin-left:11px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:18px;">Заметки об оптимизации: </span><a href="http://blogerator.ru/page/zametki-ob-optimizacii-programm-3-funkcii-s-bolshimi-nakladnymi-rashodami-i-optimizacija-funkcij"><span style=" font-size:18px; text-decoration: underline; color:#999999;">Функции с большими накладными расходами</span></a></li></ul>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555; background-color:transparent;">А поскольку впереди предстоит ещё целый длинный</span><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555;"> </span><span style=" font-family:'Georgia,serif'; font-size:8.25pt; font-style:italic; color:#555555; background-color:transparent;">сериал</span><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555;"> заметок на эту тему, самое время уступить место злой самоиронии:</span></p>
<p align="center" style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><img src="image6926.jpg" /></p>
<p style=" margin-top:20px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:transparent;"><span style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555; background-color:transparent;">Похожие страницы:</span></p>
<table border="0" style=" margin-top:0px; margin-bottom:18px; margin-left:0px; margin-right:0px;" width="100%" cellspacing="2" cellpadding="0" bgcolor="transparent">
<tr>
<td bgcolor="transparent" style=" padding-left:0; padding-right:0; padding-top:0; padding-bottom:0;">
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555; background-color:transparent;" style=" margin-top:20px; margin-bottom:0px; margin-left:16px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://blogerator.ru/page/zametki-ob-optimizacii-programm-2-big-o-notation-skorost-algoritmov-i-optimizacija-funkcij"><span style=" font-size:16px; text-decoration: underline; color:#999999;">Заметки об оптимизации: Big O notation и скорость алгоритмов</span></a></li>
<li style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555; background-color:transparent;" style=" margin-top:0px; margin-bottom:0px; margin-left:16px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://blogerator.ru/page/oop-tverdye-obektno-orientirovannye-principy-princip-liskov-php"><span style=" font-size:16px; text-decoration: underline; color:#999999;">Твердые объектно-ориентированные принципы. Принцип Лисков</span></a></li>
<li style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555; background-color:transparent;" style=" margin-top:0px; margin-bottom:0px; margin-left:16px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://blogerator.ru/page/high-load-balansirovka-nagruzki-servera-po-metodu-sticky-load-balancing"><span style=" font-size:16px; text-decoration: underline; color:#999999;">Балансировка нагрузки сервера по методу SLB</span></a></li>
<li style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555; background-color:transparent;" style=" margin-top:0px; margin-bottom:0px; margin-left:16px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://blogerator.ru/page/zametki-ob-optimizacii-programm-3-funkcii-s-bolshimi-nakladnymi-rashodami-i-optimizacija-funkcij"><span style=" font-size:16px; text-decoration: underline; color:#999999;">Заметки об оптимизации: Функции с большим оверхедом</span></a></li>
<li style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555; background-color:transparent;" style=" margin-top:0px; margin-bottom:0px; margin-left:16px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://blogerator.ru/page/high-load-raschet-planirovanie-nagruzka-na-server"><span style=" font-size:16px; text-decoration: underline; color:#999999;">Планирование нагрузки на сервер</span></a></li>
<li style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555; background-color:transparent;" style=" margin-top:0px; margin-bottom:0px; margin-left:16px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://blogerator.ru/page/oop-tverdye-obektno-orientirovannye-principy-solid-php"><span style=" font-size:16px; text-decoration: underline; color:#999999;">Твердые объектно-ориентированные принципы. SOLID</span></a></li>
<li style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555; background-color:transparent;" style=" margin-top:0px; margin-bottom:0px; margin-left:16px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://blogerator.ru/page/nemerle-ili-obshhaja-teorija-bezopasnogo-koda-2"><span style=" font-size:16px; text-decoration: underline; color:#999999;">Kung-Fu Nemerle или общая теория безопасного кода. Часть 2</span></a></li>
<li style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555; background-color:transparent;" style=" margin-top:0px; margin-bottom:0px; margin-left:16px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://blogerator.ru/page/wetware-nootropy-dlja-razgona-mozga-1"><span style=" font-size:16px; text-decoration: underline; color:#999999;">Ломаем wetware: ноотропы для разгона мозга. Часть1</span></a></li>
<li style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555; background-color:transparent;" style=" margin-top:0px; margin-bottom:0px; margin-left:16px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://blogerator.ru/page/oop-patterny-i-principy-grasp"><span style=" font-size:16px; text-decoration: underline; color:#999999;">Принципы GRASP</span></a></li>
<li style=" font-family:'Georgia,serif'; font-size:8.25pt; color:#555555; background-color:transparent;" style=" margin-top:0px; margin-bottom:20px; margin-left:16px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://blogerator.ru/page/ocenka-kolichestva-unikalnyh-elementov-v-bolshom-spiske-element-spiska-algoritm-sortirovki"><span style=" font-size:16px; text-decoration: underline; color:#999999;">Оценка количества уникальных элементов в большом списке</span></a></li></ul></td></tr></table></body></html>